<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>International iBCI Patient Registry</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- Google Fonts: Using Lora for headings and Inter for body text -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600&family=Inter:wght@300;400;500;700&display=swap"
    rel="stylesheet"
  />

  <!-- Include Papa Parse Library from a CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

  <!-- Inline CSS -->
  <style>
    /* =============== BASE RESET & GLOBAL STYLES =============== */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      scroll-behavior: smooth;
      overscroll-behavior: none;
      font-size: 16px;
      line-height: 1.4;
      font-family: "Inter", "Söhne", sans-serif;
      background-color: #FCFBE8; /* Muted background */
      color: #373737;
      -webkit-font-smoothing: antialiased;
      display: flex;
      flex-direction: column;
    }
    h1, h2, h3, h4, h5, h6 {
      font-family: "Lora", serif;
      margin: 0.8em 0 0.4em;
      font-weight: 600;
      color: #373737;
    }
    a {
      color: #373737;
      text-decoration: underline;
      text-underline-offset: 0.3em;
    }
    .container {
      width: 90%;
      max-width: 1200px;
      margin: 0 auto;
      padding-top: 1rem;
      padding-bottom: 1rem;
      flex: 1; /* main content flex */
    }

    /* =============== NAVBAR =============== */
    .navbar {
      background: #FCFBE8;
      border-bottom: 1px solid #373737;
      padding: 0.8rem;
    }
    .navbar h1 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 600;
    }

    /* =============== SUMMARY ALERT =============== */
    .summary-alert {
      background: #fff;
      border: 1px solid #373737;
      color: #373737;
      font-weight: 500;
      text-align: center;
      padding: 0.5rem 1rem;
      margin-bottom: 1.5rem;
    }

    /* =============== SEARCH INPUT =============== */
    .search-bar {
      display: flex;
      justify-content: center;
      margin-bottom: 1rem;
    }
    .search-bar input {
      width: 100%;
      max-width: 500px;
      padding: 0.6rem;
      border: 1px solid #373737;
      font-size: 0.95rem;
      color: #373737;
      background: #fff;
    }
    .search-bar input::placeholder {
      color: #999;
    }

    /* =============== TABLE STYLES =============== */
    .table-container {
      overflow-x: auto;
      background: #fff;
      border: 1px solid #373737;
      margin-bottom: 2rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 900px;
    }
    thead {
      background: #f5f5f5;
      border-bottom: 2px solid #373737;
    }
    th, td {
      text-align: left;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #ddd;
      vertical-align: middle;
    }
    th {
      font-weight: 600;
      font-family: "Lora", serif;
      color: #373737;
      cursor: pointer;
      user-select: none;
      position: relative;
    }
    th.sorted {
      background-color: #e0e0e0;
    }
    th .sort-indicator {
      margin-left: 0.5rem;
      font-size: 0.8rem;
    }
    tbody tr:hover {
      background: #fafafa;
    }

    /* =============== FOOTER =============== */
    footer.footer {
      background: #FCFBE8;
      border-top: 1px solid #373737;
      text-align: center;
      padding: 0.5rem;
      font-size: 0.9rem;
      margin-top: auto;
    }
    footer.footer p {
      margin: 0;
      font-weight: 300;
    }
    footer.footer .last-updated {
      display: block;
      font-size: 0.85rem;
      margin-top: 0.3rem;
      color: #555;
    }

    /* =============== RESPONSIVE =============== */
    @media (max-width: 600px) {
      .summary-alert { font-size: 0.95rem; }
      th, td { font-size: 0.9rem; }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="container" style="border: none; padding: 0;">
      <h1>International iBCI Patient Registry</h1>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container">
    <!-- Summary Alert -->
    <div class="summary-alert">
      <strong>Total number of patients implanted with an iBCI: 80</strong>
    </div>

    <!-- Search Bar -->
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Search by any field..." onkeyup="filterTable()" />
    </div>

    <!-- Table Container -->
    <div class="table-container">
      <table id="ibciTable">
        <thead>
          <tr>
            <th id="th-patientID" onclick="sortTable('patientID')">
              Patient ID
              <span id="sortIndicator-patientID" class="sort-indicator"></span>
            </th>
            <th id="th-originalID" onclick="sortTable('originalID')">
              Original ID
              <span id="sortIndicator-originalID" class="sort-indicator"></span>
            </th>
            <th id="th-year" onclick="sortTable('year')">
              Year of Implant
              <span id="sortIndicator-year" class="sort-indicator"></span>
            </th>
            <th id="th-institution" onclick="sortTable('institution')">
              Institution/Company
              <span id="sortIndicator-institution" class="sort-indicator"></span>
            </th>
            <th id="th-deviceType" onclick="sortTable('deviceType')">
              Device Type
              <span id="sortIndicator-deviceType" class="sort-indicator"></span>
            </th>
            <th id="th-location" onclick="sortTable('location')">
              Implant Location
              <span id="sortIndicator-location" class="sort-indicator"></span>
            </th>
            <th id="th-sex" onclick="sortTable('sex')">
              Sex
              <span id="sortIndicator-sex" class="sort-indicator"></span>
            </th>
            <th id="th-age" onclick="sortTable('age')">
              Age at Implant
              <span id="sortIndicator-age" class="sort-indicator"></span>
            </th>
            <th id="th-etiology" onclick="sortTable('etiology')">
              Etiology of Paralysis
              <span id="sortIndicator-etiology" class="sort-indicator"></span>
            </th>
            <th id="th-tasks" onclick="sortTable('tasks')">
              Tasks Performed
              <span id="sortIndicator-tasks" class="sort-indicator"></span>
            </th>
            <th id="th-firstPublication" onclick="sortTable('firstPublication')">
              First Publication
              <span id="sortIndicator-firstPublication" class="sort-indicator"></span>
            </th>
          </tr>
        </thead>
        <tbody id="ibciTableBody">
          <!-- Rows will be populated by JavaScript -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <p>Created by Jamie Brannigan and Esmee Dohle</p>
    <span class="last-updated">Last updated: 9th February 2025</span>
  </footer>

  <!-- Inline JavaScript -->
  <script>
    // Default sort by "year" ascending, with no highlight on initial load.
    let currentSortKey = "year";
    let currentSortDirection = 1; // 1 => ascending, -1 => descending
    let userHasClickedSort = false;

    // We'll store the data from the Google Sheet here.
    let ibciPatients = [];

    // Google Sheets CSV URL (you must replace with your live published CSV link)
    const googleSheetCSVUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS9vV_4d26H9_aqUAcorYkCpOaaJsoIF3ocok3JVQO27KiQ8wCqQdB796qVvgmUQ9hzYUQDcO5JGR1b/pub?output=csv";

    // Parse the "First Publication" field; we show a single entry: "Smith et al, 2020|https://..."
    function parseFirstPublication(pubString) {
      if (!pubString) return null;
      const entries = pubString.split(";");
      const firstEntry = entries[0].trim();
      if (!firstEntry) return null;
      const parts = firstEntry.split("|");
      return {
        display: parts[0].trim(),
        link: parts[1] ? parts[1].trim() : "#"
      };
    }

    // Fetch data from the Google Sheet in CSV format using PapaParse
    Papa.parse(googleSheetCSVUrl, {
      download: true,
      header: true,
      complete: function(results) {
        // Transform the CSV rows
        ibciPatients = results.data.map(record => ({
          patientID: record["Patient ID"],
          originalID: record["Original ID"],
          year: parseInt(record["Year of Implant"]),
          institution: record["Institution/Company"],
          deviceType: record["Device Type"],
          location: record["Implant Location"],
          sex: record["Sex"],
          age: parseInt(record["Age at Implant"]),
          etiology: record["Etiology of Paralysis"],
          tasks: record["Tasks Performed"],
          firstPublication: parseFirstPublication(record["First Publication"])
        }));

        // Sort by year ascending, no highlight
        sortData(currentSortKey, currentSortDirection);
        populateTable();
        // We won't call updateSortIndicators() to avoid highlighting the default column
      }
    });

    // Generic data sort function
    function sortData(key, direction) {
      ibciPatients.sort((a, b) => {
        let valA = a[key], valB = b[key];

        // For firstPublication, sort by its "display" text
        if (key === "firstPublication") {
          valA = a.firstPublication ? a.firstPublication.display : "";
          valB = b.firstPublication ? b.firstPublication.display : "";
        }

        if (typeof valA === "number" && typeof valB === "number") {
          return (valA - valB) * direction;
        } else {
          valA = String(valA).toLowerCase();
          valB = String(valB).toLowerCase();
          return valA.localeCompare(valB) * direction;
        }
      });
    }

    // Handle header click
    function sortTable(key) {
      // The user has now manually clicked a column -> highlight is allowed
      userHasClickedSort = true;

      if (currentSortKey === key) {
        // If the same column is clicked again, toggle ascending/descending
        currentSortDirection = -currentSortDirection;
      } else {
        currentSortKey = key;
        currentSortDirection = 1; // reset to ascending
      }

      sortData(currentSortKey, currentSortDirection);
      populateTable();
      updateSortIndicators();
    }

    // Update column highlight & arrow, only if userHasClickedSort is true
    function updateSortIndicators() {
      if (!userHasClickedSort) return;

      // The column keys
      const sortKeys = [
        "patientID","originalID","year","institution","deviceType","location",
        "sex","age","etiology","tasks","firstPublication"
      ];

      sortKeys.forEach(key => {
        const indicator = document.getElementById("sortIndicator-" + key);
        const th = document.getElementById("th-" + key);

        if (key === currentSortKey) {
          indicator.textContent = currentSortDirection === 1 ? "▲" : "▼";
          th.classList.add("sorted");
        } else {
          indicator.textContent = "";
          th.classList.remove("sorted");
        }
      });
    }

    // Insert table rows into DOM
    function populateTable() {
      const tbody = document.getElementById("ibciTableBody");
      tbody.innerHTML = "";

      ibciPatients.forEach(patient => {
        const row = document.createElement("tr");

        // Helper cell creation
        function createCell(content) {
          const cell = document.createElement("td");
          cell.textContent = content;
          return cell;
        }

        // 1. Patient ID
        row.appendChild(createCell(patient.patientID || "N/A"));
        // 2. Original ID
        row.appendChild(createCell(patient.originalID || "N/A"));
        // 3. Year
        row.appendChild(createCell(patient.year || "N/A"));
        // 4. Institution
        row.appendChild(createCell(patient.institution || "N/A"));
        // 5. Device Type
        row.appendChild(createCell(patient.deviceType || "N/A"));
        // 6. Implant Location
        row.appendChild(createCell(patient.location || "N/A"));
        // 7. Sex
        row.appendChild(createCell(patient.sex || "N/A"));
        // 8. Age
        row.appendChild(createCell(patient.age || "N/A"));
        // 9. Etiology
        row.appendChild(createCell(patient.etiology || "N/A"));
        // 10. Tasks Performed
        row.appendChild(createCell(patient.tasks || "N/A"));

        // 11. First Publication
        const pubCell = document.createElement("td");
        if (patient.firstPublication) {
          const anchor = document.createElement("a");
          anchor.href = patient.firstPublication.link;
          anchor.target = "_blank";
          anchor.rel = "noopener noreferrer";
          anchor.textContent = patient.firstPublication.display;
          pubCell.appendChild(anchor);
        } else {
          pubCell.textContent = "N/A";
        }
        row.appendChild(pubCell);

        tbody.appendChild(row);
      });
    }

    // Filter rows by search input
    function filterTable() {
      const input = document.getElementById("searchInput");
      const filter = input.value.toLowerCase();
      const tbody = document.getElementById("ibciTableBody");
      const rows = tbody.getElementsByTagName("tr");

      for (let i = 0; i < rows.length; i++) {
        const cells = rows[i].getElementsByTagName("td");
        let match = false;
        for (let j = 0; j < cells.length; j++) {
          if (cells[j].textContent.toLowerCase().indexOf(filter) > -1) {
            match = true;
            break;
          }
        }
        rows[i].style.display = match ? "" : "none";
      }
    }
  </script>
</body>
</html>



