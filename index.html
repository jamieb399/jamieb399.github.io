<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>International iBCI Patient Registry</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- Google Fonts: Using Lora for headings and Inter for body text -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600&family=Inter:wght@300;400;500;700&display=swap"
    rel="stylesheet"
  />

  <!-- Include Papa Parse Library from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

  <!-- Inline CSS -->
  <style>
    /* =============== BASE RESET & GLOBAL STYLES =============== */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      scroll-behavior: smooth;
      overscroll-behavior: none;
      font-size: 16px;
      line-height: 1.4;
      font-family: "Inter", "Söhne", sans-serif;
      background-color: #FCFBE8; /* Muted background */
      color: #373737;
      -webkit-font-smoothing: antialiased;
      display: flex;
      flex-direction: column;
    }
    h1, h2, h3, h4, h5, h6 {
      font-family: "Lora", serif;
      margin: 0.8em 0 0.4em;
      font-weight: 600;
      color: #373737;
    }
    a {
      color: #373737;
      text-decoration: underline;
      text-underline-offset: 0.3em;
    }
    .container {
      width: 90%;
      max-width: 1200px;
      margin: 0 auto;
      padding-top: 1rem;
      padding-bottom: 1rem;
      flex: 1;
    }

    /* =============== NAVBAR =============== */
    .navbar {
      background: #FCFBE8;
      border-bottom: 1px solid #373737;
      padding: 0.8rem;
    }
    .navbar h1 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 600;
    }

    /* =============== SUMMARY ALERT =============== */
    .summary-alert {
      background: #fff;
      border: 1px solid #373737;
      color: #373737;
      font-weight: 500;
      text-align: center;
      padding: 0.5rem 1rem;
      margin-bottom: 1.5rem;
    }

    /* =============== SEARCH INPUT =============== */
    .search-bar {
      display: flex;
      justify-content: center;
      margin-bottom: 1rem;
    }
    .search-bar input {
      width: 100%;
      max-width: 500px;
      padding: 0.6rem;
      border: 1px solid #373737;
      font-size: 0.95rem;
      color: #373737;
      background: #fff;
    }
    .search-bar input::placeholder {
      color: #999;
    }

    /* =============== TABLE STYLES =============== */
    .table-container {
      overflow-x: auto;
      background: #fff;
      border: 1px solid #373737;
      margin-bottom: 2rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }
    thead {
      background: #f5f5f5;
      border-bottom: 2px solid #373737;
    }
    th, td {
      text-align: left;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #ddd;
      vertical-align: middle;
    }
    th {
      font-weight: 600;
      font-family: "Lora", serif;
      color: #373737;
      cursor: pointer;
      user-select: none;
      position: relative;
    }
    th.sorted {
      background-color: #e0e0e0;
    }
    th .sort-indicator {
      margin-left: 0.5rem;
      font-size: 0.8rem;
    }
    tbody tr:hover {
      background: #fafafa;
    }

    /* =============== FOOTER =============== */
    footer.footer {
      background: #FCFBE8;
      border-top: 1px solid #373737;
      text-align: center;
      padding: 0.5rem;
      font-size: 0.9rem;
      margin-top: auto;
    }
    footer.footer p {
      margin: 0;
      font-weight: 300;
    }
    footer.footer .last-updated {
      display: block;
      font-size: 0.85rem;
      margin-top: 0.3rem;
      color: #555;
    }

    /* =============== RESPONSIVE =============== */
    @media (max-width: 600px) {
      .summary-alert { font-size: 0.95rem; }
      th, td { font-size: 0.9rem; }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="container" style="border: none; padding: 0;">
      <h1>International iBCI Patient Registry</h1>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container">
    <!-- Summary Alert -->
    <div class="summary-alert">
      <strong>Total number of patients implanted with an iBCI: 80</strong>
    </div>

    <!-- Search Bar -->
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Search by any field..." onkeyup="filterTable()" />
    </div>

    <!-- Table Container -->
    <div class="table-container">
      <table id="ibciTable">
        <thead>
          <tr>
            <th id="th-patientID" onclick="sortTable('patientID')">Patient ID <span id="sortIndicator-patientID" class="sort-indicator"></span></th>
            <th id="th-year" onclick="sortTable('year')">Year of Implant <span id="sortIndicator-year" class="sort-indicator"></span></th>
            <th id="th-institution" onclick="sortTable('institution')">Institution/Company <span id="sortIndicator-institution" class="sort-indicator"></span></th>
            <th id="th-deviceType" onclick="sortTable('deviceType')">Device Type <span id="sortIndicator-deviceType" class="sort-indicator"></span></th>
            <th id="th-sex" onclick="sortTable('sex')">Sex <span id="sortIndicator-sex" class="sort-indicator"></span></th>
            <th id="th-age" onclick="sortTable('age')">Age at Implant <span id="sortIndicator-age" class="sort-indicator"></span></th>
            <th id="th-etiology" onclick="sortTable('etiology')">Etiology of Paralysis <span id="sortIndicator-etiology" class="sort-indicator"></span></th>
            <th id="th-tasks" onclick="sortTable('tasks')">Tasks Performed <span id="sortIndicator-tasks" class="sort-indicator"></span></th>
            <th id="th-firstPublication" onclick="sortTable('firstPublication')">First Publication <span id="sortIndicator-firstPublication" class="sort-indicator"></span></th>
          </tr>
        </thead>
        <tbody id="ibciTableBody">
          <!-- Rows will be populated by JavaScript -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <p>Created by Jamie Brannigan and Esmee Dohle</p>
    <span class="last-updated">Last updated: 9th February 2025</span>
  </footer>

  <!-- Inline JavaScript -->
  <script>
    // Global sort state – default sort by patientID.
    let currentSortKey = "patientID";
    let currentSortDirection = 1; // 1 for ascending, -1 for descending

    // This will hold the patient data from the spreadsheet.
    let ibciPatients = [];

    // Google Sheets CSV URL – REPLACE "your-spreadsheet-id" with your actual ID.
    const googleSheetCSVUrl = "https://docs.google.com/spreadsheets/d/your-spreadsheet-id/pub?output=csv";

    // Parse the "First Publication" field: split by semicolon and take only the first entry.
    // Expected format: "Vansteensel et al, 2016|https://link; Other pub|https://link2"
    function parseFirstPublication(pubString) {
      if (!pubString) return null;
      const entries = pubString.split(";");
      const firstEntry = entries[0].trim();
      if (!firstEntry) return null;
      const parts = firstEntry.split("|");
      return {
        display: parts[0].trim(),
        link: parts[1] ? parts[1].trim() : "#"
      };
    }

    // Fetch data from the Google Sheet and then populate the table.
    Papa.parse(googleSheetCSVUrl, {
      download: true,
      header: true,
      complete: function(results) {
        // Map CSV records into our data structure.
        ibciPatients = results.data.map(record => ({
          patientID: record["Patient ID"],
          year: parseInt(record["Year of Implant"]),
          institution: record["Institution/Company"],
          deviceType: record["Device Type"],
          sex: record["Sex"],
          age: parseInt(record["Age at Implant"]),
          etiology: record["Etiology of Paralysis"],
          tasks: record["Tasks Performed"],
          firstPublication: parseFirstPublication(record["First Publication"])
        }));
        // Default sort by patientID.
        sortData(currentSortKey, currentSortDirection);
        populateTable();
        updateSortIndicators();
      }
    });

    // Generic data sort function.
    function sortData(key, direction) {
      ibciPatients.sort((a, b) => {
        let valA = a[key], valB = b[key];

        // For the firstPublication column, sort by the display text.
        if (key === "firstPublication") {
          valA = a.firstPublication ? a.firstPublication.display : "";
          valB = b.firstPublication ? b.firstPublication.display : "";
        }
        if (typeof valA === "number" && typeof valB === "number") {
          return (valA - valB) * direction;
        } else {
          valA = String(valA).toLowerCase();
          valB = String(valB).toLowerCase();
          return valA.localeCompare(valB) * direction;
        }
      });
    }

    // Called when a header is clicked.
    function sortTable(key) {
      if (currentSortKey === key) {
        currentSortDirection = -currentSortDirection;
      } else {
        currentSortKey = key;
        currentSortDirection = 1;
      }
      sortData(currentSortKey, currentSortDirection);
      populateTable();
      updateSortIndicators();
    }

    // Update sort indicators and highlight active header.
    function updateSortIndicators() {
      const sortKeys = ["patientID", "year", "institution", "deviceType", "sex", "age", "etiology", "tasks", "firstPublication"];
      sortKeys.forEach(key => {
        const indicator = document.getElementById("sortIndicator-" + key);
        const th = document.getElementById("th-" + key);
        if (key === currentSortKey) {
          indicator.textContent = currentSortDirection === 1 ? "▲" : "▼";
          th.classList.add("sorted");
        } else {
          indicator.textContent = "";
          th.classList.remove("sorted");
        }
      });
    }

    // Populate the table with data.
    function populateTable() {
      const tbody = document.getElementById("ibciTableBody");
      tbody.innerHTML = "";
      ibciPatients.forEach(patient => {
        const row = document.createElement("tr");

        // Helper to create cell.
        function createCell(content) {
          const cell = document.createElement("td");
          cell.textContent = content;
          return cell;
        }

        // Patient ID
        row.appendChild(createCell(patient.patientID));
        // Year of Implant
        row.appendChild(createCell(patient.year));
        // Institution/Company
        row.appendChild(createCell(patient.institution));
        // Device Type
        row.appendChild(createCell(patient.deviceType));
        // Sex
        row.appendChild(createCell(patient.sex));
        // Age at Implant
        row.appendChild(createCell(patient.age));
        // Etiology of Paralysis
        row.appendChild(createCell(patient.etiology));
        // Tasks Performed
        row.appendChild(createCell(patient.tasks));

        // First Publication cell
        const pubCell = document.createElement("td");
        if (patient.firstPublication) {
          const anchor = document.createElement("a");
          anchor.href = patient.firstPublication.link;
          anchor.target = "_blank";
          anchor.rel = "noopener noreferrer";
          anchor.textContent = patient.firstPublication.display;
          pubCell.appendChild(anchor);
        } else {
          pubCell.textContent = "N/A";
        }
        row.appendChild(pubCell);

        tbody.appendChild(row);
      });
    }

    // Filter table rows based on the search input.
    function filterTable() {
      const input = document.getElementById("searchInput");
      const filter = input.value.toLowerCase();
      const tbody = document.getElementById("ibciTableBody");
      const rows = tbody.getElementsByTagName("tr");
      for (let i = 0; i < rows.length; i++) {
        let row = rows[i];
        let cells = row.getElementsByTagName("td");
        let match = false;
        for (let j = 0; j < cells.length; j++) {
          if (cells[j].textContent.toLowerCase().indexOf(filter) > -1) {
            match = true;
            break;
          }
        }
        row.style.display = match ? "" : "none";
      }
    }
  </script>
</body>
</html>






